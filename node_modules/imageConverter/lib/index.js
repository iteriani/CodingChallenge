/* Module to handle conversion of PDFs to png thumbnails. Requires ImageMagick to be installed.
 * You can install ImageMagick at http://www.imagemagick.org/
 */
var exec = require('child_process').spawn;
var path = require("path");
var fs = require("fs");

var converter = {


};

/* Primary function to convert files. 
 * Arguments :
 *	            filepath -- filepath of file to be converted. must be pdf
 *	            output_directory -- directory of file to be converted to.
 *	            callback(files) -- when conversion finishes, a list of file paths is returned.
 *	            opts -- optional parameters. includes density, size, and file format
 *	Returns : nothing.
 */
converter.convert = function(filepath, output_directory, callback, opts) {
    if (opts === undefined) {
        opts = {};
    }
    var density = opts.density || 600;
    var size = opts.size || "100x100";
    var format = opts.format || "png";
    var file_name = path.basename(filepath).split(".")[0];
    var errorFound = false;
    var child = exec("convert", ["-density", density, "-thumbnail", size, filepath, output_directory + "/" + file_name + "_thumbnail_page_%d." + format],
        callback);
    console.log("beginning conversion");

    child.stdout.on('data', function(data) {
        console.log('stdout: ' + data);
    });

    /* I could throw an error here, but some of the errors are warnings or just output from ImageMagick. */
    child.stderr.on('data', function(data) {
        console.log('stderr: ' + data);
    });

    /* I can only give out an error for having no files generated at all. */
    child.on('close', function(code) {
        var files = [];
        /* Counts number of files converted, assuming that there are no identical files. */
        var data = fs.readdirSync(output_directory);
        for (var i = 0; i < data.length; i++) {
            if (data[i].indexOf(file_name + "_") >= 0) {
                files.push(output_directory + "/" + data[i]);
            }
        }
        callback(files);
        console.log('child process exited with code ' + code);

    });
};


module.exports = converter;